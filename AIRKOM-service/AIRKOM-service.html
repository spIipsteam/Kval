<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
    <title>АЭРКОМ-Сервис - Вход в систему</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
            width: 100%;
        }

        /* Стили для основного приложения (после входа) */
        .sidebar {
            width: 260px;
            background-color: #2c3e50;
            color: #ecf0f1;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            position: sticky;
            top: 0;
            height: 100vh;
        }

        .logo {
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid #34495e;
        }

        .logo span {
            font-size: 18px;
            font-weight: 500;
        }

        .nav-menu {
            flex: 1;
            padding: 20px 0;
        }

        .nav-menu ul {
            list-style: none;
        }

        .nav-menu li {
            padding: 15px 25px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: background 0.3s;
            color: #bdc3c7;
        }

        .nav-menu li i {
            width: 20px;
            font-size: 18px;
        }

        .nav-menu li:hover {
            background-color: #34495e;
            color: #fff;
        }

        .nav-menu li.active {
            background-color: #3498db;
            color: #fff;
        }

        .user-info {
            padding: 20px;
            border-top: 1px solid #34495e;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
        }

        .user-info i:first-child {
            font-size: 40px;
        }

        .user-name {
            font-weight: 500;
            font-size: 14px;
        }

        .user-role {
            font-size: 12px;
            color: #bdc3c7;
        }

        .logout-icon {
            position: absolute;
            right: 20px;
            cursor: pointer;
            font-size: 18px;
            color: #e74c3c;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #f5f7fa;
        }

        .mobile-header {
            display: none;
            background-color: #fff;
            padding: 15px 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            align-items: center;
            justify-content: space-between;
        }

        .menu-toggle {
            font-size: 24px;
            cursor: pointer;
            color: #2c3e50;
        }

        .content-area {
            padding: 25px;
            flex: 1;
        }

        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .stat-card {
            background-color: #fff;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
        }

        .stat-icon.clients { background-color: #e3f2fd; color: #1976d2; }
        .stat-icon.requests { background-color: #fff3e0; color: #f57c00; }
        .stat-icon.masters { background-color: #e8f5e9; color: #388e3c; }
        .stat-icon.warehouse { background-color: #fce4ec; color: #c2185b; }

        .stat-details h3 {
            font-size: 14px;
            font-weight: 400;
            color: #7f8c8d;
        }

        .stat-number {
            font-size: 32px;
            font-weight: 700;
            color: #2c3e50;
        }

        .table-container {
            background-color: #fff;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: #3498db;
            color: #fff;
        }

        .btn-primary:hover {
            background-color: #2980b9;
        }

        .btn-success {
            background-color: #27ae60;
            color: #fff;
        }

        .btn-danger {
            background-color: #e74c3c;
            color: #fff;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 15px 10px;
            background-color: #f8f9fa;
            color: #2c3e50;
            font-weight: 500;
            border-bottom: 2px solid #e9ecef;
        }

        td {
            padding: 15px 10px;
            border-bottom: 1px solid #e9ecef;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            display: inline-block;
        }

        .status-new { background-color: #e3f2fd; color: #1976d2; }
        .status-in-progress { background-color: #fff3e0; color: #f57c00; }
        .status-done { background-color: #e8f5e9; color: #388e3c; }
        .status-cancelled { background-color: #fce4ec; color: #c2185b; }

        .priority-high { color: #e74c3c; font-weight: 500; }
        .priority-normal { color: #f39c12; font-weight: 500; }

        .action-icons i {
            margin: 0 5px;
            cursor: pointer;
            color: #7f8c8d;
        }

        .action-icons i:hover { color: #3498db; }
        .action-icons i.fa-trash:hover { color: #e74c3c; }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: #fff;
            margin: 50px auto;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            position: relative;
        }

        .close-modal {
            position: absolute;
            right: 20px;
            top: 10px;
            font-size: 28px;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .search-box {
            margin-bottom: 20px;
            position: relative;
        }

        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #7f8c8d;
        }

        .search-box input {
            width: 100%;
            padding: 12px 15px 12px 45px;
            border: 1px solid #ddd;
            border-radius: 30px;
        }

        /* Стили для окон авторизации */
        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .auth-container {
            display: flex;
            gap: 30px;
            max-width: 900px;
            width: 90%;
            flex-wrap: wrap;
            justify-content: center;
        }

        .auth-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            width: 350px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
            transition: transform 0.3s;
        }

        .auth-card:hover {
            transform: translateY(-10px);
        }

        .auth-icon {
            font-size: 80px;
            color: #3498db;
            margin-bottom: 20px;
        }

        .auth-card h2 {
            font-size: 28px;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .auth-card .role-desc {
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .auth-input {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
        }

        .auth-btn {
            width: 100%;
            padding: 15px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            margin: 10px 0;
            transition: background 0.3s;
        }

        .auth-btn:hover {
            background: #2980b9;
        }

        .auth-btn.manager {
            background: #27ae60;
        }

        .auth-btn.manager:hover {
            background: #219a52;
        }

        .auth-footer {
            margin-top: 20px;
            color: #95a5a6;
            font-size: 12px;
        }

        .manager-card .auth-icon { color: #27ae60; }
        .master-card .auth-icon { color: #e67e22; }

        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                z-index: 100;
                transform: translateX(-100%);
            }
            .sidebar.show { transform: translateX(0); }
            .mobile-header { display: flex; }
            .dashboard-stats { grid-template-columns: 1fr; }
            .auth-container { flex-direction: column; align-items: center; }
        }
    </style>
</head>
<body>
    <!-- Окна авторизации -->
    <div class="auth-overlay" id="authOverlay">
        <div class="auth-container">
            <!-- Карточка входа для Менеджера -->
            <div class="auth-card manager-card">
                <div class="auth-icon">
                    <i class="fas fa-user-tie"></i>
                </div>
                <h2>Менеджер</h2>
                <div class="role-desc">Управление клиентами, заявками и отчетами</div>
                
                <input type="text" class="auth-input" id="managerLogin" placeholder="Логин" value="manager">
                <input type="password" class="auth-input" id="managerPassword" placeholder="Пароль" value="manager123">
                
                <button class="auth-btn manager" onclick="loginAsManager()">
                    <i class="fas fa-sign-in-alt"></i> Войти как менеджер
                </button>
                
                <div class="auth-footer">
                    <i class="fas fa-lock"></i> Доступ только для сотрудников
                </div>
            </div>

            <!-- Карточка входа для Мастера -->
            <div class="auth-card master-card">
                <div class="auth-icon">
                    <i class="fas fa-tools"></i>
                </div>
                <h2>Мастер</h2>
                <div class="role-desc">Просмотр задач, выполнение работ, списание материалов</div>
                
                <input type="text" class="auth-input" id="masterLogin" placeholder="Логин" value="master">
                <input type="password" class="auth-input" id="masterPassword" placeholder="Пароль" value="master123">
                
                <button class="auth-btn" onclick="loginAsMaster()">
                    <i class="fas fa-sign-in-alt"></i> Войти как мастер
                </button>
                
                <div class="auth-footer">
                    <i class="fas fa-lock"></i> Доступ только для сотрудников
                </div>
            </div>
        </div>
    </div>

    <!-- Основное приложение (изначально скрыто) -->
    <div class="app-container" id="appContainer" style="display: none;">
        <aside class="sidebar" id="sidebar">
            <div class="logo">
                <i class="fas fa-building" style="font-size: 30px;"></i>
                <span>АЭРКОМ-Сервис</span>
            </div>
            <nav class="nav-menu">
                <ul id="menuList">
                    <li class="active" data-page="dashboard"><i class="fas fa-tachometer-alt"></i> <span>Главная</span></li>
                    <li data-page="clients"><i class="fas fa-users"></i> <span>Клиенты</span></li>
                    <li data-page="requests"><i class="fas fa-clipboard-list"></i> <span>Заявки</span></li>
                    <li data-page="masters"><i class="fas fa-user-cog"></i> <span>Мастера</span></li>
                    <li data-page="warehouse"><i class="fas fa-boxes"></i> <span>Склад</span></li>
                </ul>
            </nav>
            <div class="user-info" id="userInfo">
                <i class="fas fa-user-circle"></i>
                <div>
                    <div class="user-name" id="userName">Загрузка...</div>
                    <div class="user-role" id="userRole">...</div>
                </div>
                <i class="fas fa-sign-out-alt logout-icon" id="logoutBtn"></i>
            </div>
        </aside>

        <main class="main-content">
            <header class="mobile-header">
                <i class="fas fa-bars menu-toggle" id="menuToggle"></i>
                <h1>АЭРКОМ-Сервис</h1>
                <i class="fas fa-user-circle"></i>
            </header>

            <div class="content-area" id="contentArea"></div>
        </main>
    </div>

    <div class="modal" id="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
        // ========== ДАННЫЕ ==========
        let appData = {
            users: [
                { id: 1, username: 'manager', password: 'manager123', role: 'MANAGER', name: 'Иванова А.С.', phone: '+7(905)111-22-33' },
                { id: 2, username: 'master', password: 'master123', role: 'MASTER', name: 'Петров П.С.', phone: '+7(905)444-55-66', specialization: 'Ремонт' },
                { id: 3, username: 'admin', password: 'admin123', role: 'ADMIN', name: 'Администратор' }
            ],
            clients: JSON.parse(localStorage.getItem('aercom_clients')) || [
                { id: 1, name: 'ТСЖ "Солнечный"', phone: '+7(8412)55-12-34', address: 'ул. Ленина, 10' },
                { id: 2, name: 'УК "Комфорт"', phone: '+7(8412)77-56-78', address: 'ул. Мира, 25' },
                { id: 3, name: 'Петров Сергей Иванович', phone: '+7(905)123-45-67', address: 'ул. Гагарина, 15-34' }
            ],
            requests: JSON.parse(localStorage.getItem('aercom_requests')) || [
                { id: 1, number: 'SR-2024-001', clientId: 1, clientName: 'ТСЖ "Солнечный"', address: 'ул. Ленина, 10', problem: 'Не открывается дверь', priority: 'URGENT', status: 'NEW', masterId: null, createdAt: '2024-02-10T10:30:00' },
                { id: 2, number: 'SR-2024-002', clientId: 2, clientName: 'УК "Комфорт"', address: 'ул. Мира, 25', problem: 'Нет связи', priority: 'NORMAL', status: 'IN_PROGRESS', masterId: 2, createdAt: '2024-02-09T15:45:00' },
                { id: 3, number: 'SR-2024-003', clientId: 3, clientName: 'Петров Сергей Иванович', address: 'ул. Гагарина, 15-34', problem: 'Замена трубки', priority: 'NORMAL', status: 'DONE', masterId: 2, createdAt: '2024-02-08T09:15:00' }
            ],
            masters: JSON.parse(localStorage.getItem('aercom_masters')) || [
                { id: 1, name: 'Иванов П.С.', phone: '+7(905)111-22-33', specialization: 'Ремонт', status: 'ACTIVE' },
                { id: 2, name: 'Сидоров А.В.', phone: '+7(905)444-55-66', specialization: 'Установка', status: 'ACTIVE' }
            ],
            warehouse: JSON.parse(localStorage.getItem('aercom_warehouse')) || [
                { id: 1, name: 'Трубка домофонная', sku: 'TR-001', quantity: 25, minQuantity: 5, price: 350 },
                { id: 2, name: 'Панель вызова', sku: 'PN-001', quantity: 8, minQuantity: 2, price: 1200 },
                { id: 3, name: 'Блок питания', sku: 'BP-001', quantity: 3, minQuantity: 2, price: 650 }
            ]
        };

        let currentUser = null;

        // ========== СОХРАНЕНИЕ ==========
        function saveData() {
            localStorage.setItem('aercom_clients', JSON.stringify(appData.clients));
            localStorage.setItem('aercom_requests', JSON.stringify(appData.requests));
            localStorage.setItem('aercom_masters', JSON.stringify(appData.masters));
            localStorage.setItem('aercom_warehouse', JSON.stringify(appData.warehouse));
        }

        // ========== ФУНКЦИИ ВХОДА ==========
        function loginAsManager() {
            const username = document.getElementById('managerLogin').value;
            const password = document.getElementById('managerPassword').value;
            
            const user = appData.users.find(u => u.username === username && u.password === password && u.role === 'MANAGER');
            
            if (user) {
                currentUser = user;
                document.getElementById('authOverlay').style.display = 'none';
                document.getElementById('appContainer').style.display = 'flex';
                updateInterfaceByRole();
                renderPage('dashboard');
                saveData();
            } else {
                alert('Неверный логин или пароль для менеджера');
            }
        }

        function loginAsMaster() {
            const username = document.getElementById('masterLogin').value;
            const password = document.getElementById('masterPassword').value;
            
            const user = appData.users.find(u => u.username === username && u.password === password && u.role === 'MASTER');
            
            if (user) {
                currentUser = user;
                document.getElementById('authOverlay').style.display = 'none';
                document.getElementById('appContainer').style.display = 'flex';
                updateInterfaceByRole();
                renderPage('dashboard');
                saveData();
            } else {
                alert('Неверный логин или пароль для мастера');
            }
        }

        // ========== ОБНОВЛЕНИЕ ИНТЕРФЕЙСА ПО РОЛИ ==========
        function updateInterfaceByRole() {
            // Обновляем информацию о пользователе
            document.getElementById('userName').textContent = currentUser.name;
            
            let roleText = '';
            switch(currentUser.role) {
                case 'ADMIN': roleText = 'Администратор'; break;
                case 'MANAGER': roleText = 'Менеджер'; break;
                case 'MASTER': roleText = 'Мастер'; break;
            }
            document.getElementById('userRole').textContent = roleText;

            // Настраиваем меню в зависимости от роли
            const menuItems = document.querySelectorAll('.nav-menu li');
            
            if (currentUser.role === 'MASTER') {
                // Мастер видит только ограниченное меню
                menuItems.forEach(item => {
                    const page = item.dataset.page;
                    if (page === 'clients' || page === 'masters') {
                        item.style.display = 'none';
                    } else {
                        item.style.display = 'flex';
                    }
                });
            } else {
                // Менеджер и админ видят всё
                menuItems.forEach(item => item.style.display = 'flex');
            }
        }

        // ========== ВЫХОД ==========
        function logout() {
            if (confirm('Выйти из системы?')) {
                currentUser = null;
                document.getElementById('appContainer').style.display = 'none';
                document.getElementById('authOverlay').style.display = 'flex';
                
                // Очищаем поля ввода
                document.getElementById('managerLogin').value = 'manager';
                document.getElementById('managerPassword').value = 'manager123';
                document.getElementById('masterLogin').value = 'master';
                document.getElementById('masterPassword').value = 'master123';
            }
        }

        // ========== ИНИЦИАЛИЗАЦИЯ ==========
        document.addEventListener('DOMContentLoaded', function() {
            // Показываем окна авторизации
            document.getElementById('authOverlay').style.display = 'flex';
            
            // Настройка меню
            document.querySelectorAll('.nav-menu li').forEach(item => {
                item.addEventListener('click', function() {
                    document.querySelectorAll('.nav-menu li').forEach(li => li.classList.remove('active'));
                    this.classList.add('active');
                    renderPage(this.dataset.page);
                    if (window.innerWidth <= 768) document.getElementById('sidebar').classList.remove('show');
                });
            });
            
            document.getElementById('menuToggle').addEventListener('click', () => {
                document.getElementById('sidebar').classList.toggle('show');
            });
            
            document.querySelector('.close-modal').addEventListener('click', closeModal);
            window.addEventListener('click', (e) => { if (e.target.classList.contains('modal')) closeModal(); });
            
            document.getElementById('logoutBtn').addEventListener('click', logout);
        });

        // ========== МОДАЛЬНОЕ ОКНО ==========
        function openModal(title, content) {
            document.getElementById('modalBody').innerHTML = `<h2 style="margin-bottom:20px;">${title}</h2>${content}`;
            document.getElementById('modal').style.display = 'block';
        }
        function closeModal() { document.getElementById('modal').style.display = 'none'; }

        // ========== РЕНДЕРИНГ СТРАНИЦ ==========
        function renderPage(page) {
            const container = document.getElementById('contentArea');
            if (page === 'dashboard') renderDashboard(container);
            else if (page === 'clients' && currentUser.role !== 'MASTER') renderClients(container);
            else if (page === 'requests') renderRequests(container);
            else if (page === 'masters' && currentUser.role !== 'MASTER') renderMasters(container);
            else if (page === 'warehouse') renderWarehouse(container);
        }

        // ========== ДАШБОРД ==========
        function renderDashboard(container) {
            const activeRequests = appData.requests.filter(r => r.status === 'NEW' || r.status === 'IN_PROGRESS').length;
            const totalItems = appData.warehouse.reduce((sum, i) => sum + i.quantity, 0);
            
            let statsHtml = '';
            
            if (currentUser.role === 'MASTER') {
                const myRequests = appData.requests.filter(r => r.masterId === currentUser.id && r.status !== 'DONE').length;
                statsHtml = `
                    <div class="stat-card"><div class="stat-icon requests"><i class="fas fa-clipboard-list"></i></div><div class="stat-details"><h3>Мои задачи</h3><div class="stat-number">${myRequests}</div></div></div>
                    <div class="stat-card"><div class="stat-icon warehouse"><i class="fas fa-boxes"></i></div><div class="stat-details"><h3>Материалы</h3><div class="stat-number">${totalItems}</div></div></div>
                `;
            } else {
                statsHtml = `
                    <div class="stat-card"><div class="stat-icon clients"><i class="fas fa-users"></i></div><div class="stat-details"><h3>Клиенты</h3><div class="stat-number">${appData.clients.length}</div></div></div>
                    <div class="stat-card"><div class="stat-icon requests"><i class="fas fa-clipboard-list"></i></div><div class="stat-details"><h3>Активные заявки</h3><div class="stat-number">${activeRequests}</div></div></div>
                    <div class="stat-card"><div class="stat-icon masters"><i class="fas fa-user-cog"></i></div><div class="stat-details"><h3>Мастера</h3><div class="stat-number">${appData.masters.length}</div></div></div>
                    <div class="stat-card"><div class="stat-icon warehouse"><i class="fas fa-boxes"></i></div><div class="stat-details"><h3>Материалы</h3><div class="stat-number">${totalItems}</div></div></div>
                `;
            }
            
            let requestsToShow = currentUser.role === 'MASTER' 
                ? appData.requests.filter(r => r.masterId === currentUser.id).slice(0,5)
                : appData.requests.slice(0,5);
            
            container.innerHTML = `
                <div class="dashboard-stats">${statsHtml}</div>
                <div class="table-container">
                    <h2 style="margin-bottom:15px;">${currentUser.role === 'MASTER' ? 'Мои заявки' : 'Последние заявки'}</h2>
                    <table><thead><tr><th>№</th><th>Клиент</th><th>Проблема</th><th>Статус</th></tr></thead><tbody>
                        ${requestsToShow.map(r => `<tr><td>${r.number}</td><td>${r.clientName}</td><td>${r.problem}</td><td><span class="status-badge status-${r.status === 'NEW' ? 'new' : r.status === 'IN_PROGRESS' ? 'in-progress' : 'done'}">${r.status}</span></td></tr>`).join('')}
                    </tbody></table>
                </div>
            `;
        }

        // ========== КЛИЕНТЫ (только для менеджера) ==========
        function renderClients(container) {
            if (currentUser.role === 'MASTER') {
                container.innerHTML = '<div class="table-container"><h2>Доступ запрещен</h2><p>У вас нет прав для просмотра этого раздела.</p></div>';
                return;
            }
            
            container.innerHTML = `
                <div class="table-container">
                    <div class="table-header"><h2>Клиенты</h2><button class="btn btn-primary" onclick="showAddClientModal()"><i class="fas fa-plus"></i> Добавить</button></div>
                    <div class="search-box"><i class="fas fa-search"></i><input type="text" id="clientSearch" placeholder="Поиск..." onkeyup="searchTable('clientSearch', 'clientsTable')"></div>
                    <table id="clientsTable"><thead><tr><th>ID</th><th>Название</th><th>Телефон</th><th>Адрес</th><th>Действия</th></tr></thead><tbody>
                        ${appData.clients.map(c => `<tr><td>${c.id}</td><td>${c.name}</td><td>${c.phone}</td><td>${c.address}</td><td class="action-icons"><i class="fas fa-edit" onclick="showEditClientModal(${c.id})"></i> <i class="fas fa-trash" onclick="deleteClient(${c.id})"></i></td></tr>`).join('')}
                    </tbody></table>
                </div>
            `;
        }

        function showAddClientModal() {
            openModal('Добавить клиента', `
                <form onsubmit="saveClient(event)">
                    <div class="form-group"><label>Название *</label><input type="text" id="clientName" required></div>
                    <div class="form-group"><label>Телефон *</label><input type="tel" id="clientPhone" required></div>
                    <div class="form-group"><label>Адрес *</label><input type="text" id="clientAddress" required></div>
                    <div class="form-actions"><button type="button" class="btn" onclick="closeModal()">Отмена</button><button type="submit" class="btn btn-primary">Сохранить</button></div>
                </form>
            `);
        }

        function showEditClientModal(id) {
            const c = appData.clients.find(c => c.id === id);
            openModal('Редактировать', `
                <form onsubmit="updateClient(event, ${id})">
                    <div class="form-group"><label>Название *</label><input type="text" id="clientName" value="${c.name}" required></div>
                    <div class="form-group"><label>Телефон *</label><input type="tel" id="clientPhone" value="${c.phone}" required></div>
                    <div class="form-group"><label>Адрес *</label><input type="text" id="clientAddress" value="${c.address}" required></div>
                    <div class="form-actions"><button type="button" class="btn" onclick="closeModal()">Отмена</button><button type="submit" class="btn btn-primary">Обновить</button></div>
                </form>
            `);
        }

        function saveClient(e) {
            e.preventDefault();
            appData.clients.push({
                id: Date.now(),
                name: document.getElementById('clientName').value,
                phone: document.getElementById('clientPhone').value,
                address: document.getElementById('clientAddress').value
            });
            saveData(); closeModal(); renderPage('clients');
        }

        function updateClient(e, id) {
            e.preventDefault();
            const c = appData.clients.find(c => c.id === id);
            c.name = document.getElementById('clientName').value;
            c.phone = document.getElementById('clientPhone').value;
            c.address = document.getElementById('clientAddress').value;
            saveData(); closeModal(); renderPage('clients');
        }

        function deleteClient(id) {
            if (confirm('Удалить?')) {
                appData.clients = appData.clients.filter(c => c.id !== id);
                saveData(); renderPage('clients');
            }
        }

        // ========== ЗАЯВКИ ==========
        function renderRequests(container) {
            let requestsToShow = appData.requests;
            
            if (currentUser.role === 'MASTER') {
                // Мастер видит только свои заявки
                requestsToShow = appData.requests.filter(r => r.masterId === currentUser.id);
            }
            
            container.innerHTML = `
                <div class="table-container">
                    <div class="table-header"><h2>${currentUser.role === 'MASTER' ? 'Мои заявки' : 'Заявки'}</h2>
                        ${currentUser.role !== 'MASTER' ? '<button class="btn btn-primary" onclick="showAddRequestModal()"><i class="fas fa-plus"></i> Создать</button>' : ''}
                    </div>
                    <div class="search-box"><i class="fas fa-search"></i><input type="text" id="requestSearch" placeholder="Поиск..." onkeyup="searchTable('requestSearch', 'requestsTable')"></div>
                    <table id="requestsTable"><thead><tr><th>№</th><th>Клиент</th><th>Проблема</th><th>Статус</th><th>Приоритет</th><th>Действия</th></tr></thead><tbody>
                        ${requestsToShow.map(r => `<tr>
                            <td>${r.number}</td><td>${r.clientName}</td><td>${r.problem}</td>
                            <td><span class="status-badge status-${r.status === 'NEW' ? 'new' : r.status === 'IN_PROGRESS' ? 'in-progress' : 'done'}">${r.status}</span></td>
                            <td class="${r.priority === 'URGENT' ? 'priority-high' : 'priority-normal'}">${r.priority}</td>
                            <td class="action-icons">
                                ${currentUser.role === 'MASTER' && r.status === 'IN_PROGRESS' ? '<i class="fas fa-check-circle" onclick="completeRequest(' + r.id + ')"></i>' : ''}
                                ${currentUser.role !== 'MASTER' ? '<i class="fas fa-user-check" onclick="assignMaster(' + r.id + ')"></i>' : ''}
                                ${currentUser.role !== 'MASTER' ? '<i class="fas fa-trash" onclick="deleteRequest(' + r.id + ')"></i>' : ''}
                            </td>
                        </tr>`).join('')}
                    </tbody></table>
                </div>
            `;
        }

        function showAddRequestModal() {
            const clientsOptions = appData.clients.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            openModal('Новая заявка', `
                <form onsubmit="saveRequest(event)">
                    <div class="form-group"><label>Клиент *</label><select id="requestClientId" required>${clientsOptions}</select></div>
                    <div class="form-group"><label>Адрес *</label><input type="text" id="requestAddress" required></div>
                    <div class="form-group"><label>Проблема</label><input type="text" id="problemType" value="Неисправность" required></div>
                    <div class="form-group"><label>Приоритет</label><select id="requestPriority"><option value="NORMAL">Обычный</option><option value="URGENT">Срочный</option></select></div>
                    <div class="form-actions"><button type="button" class="btn" onclick="closeModal()">Отмена</button><button type="submit" class="btn btn-primary">Создать</button></div>
                </form>
            `);
        }

        function saveRequest(e) {
            e.preventDefault();
            const clientId = parseInt(document.getElementById('requestClientId').value);
            const client = appData.clients.find(c => c.id === clientId);
            appData.requests.push({
                id: Date.now(),
                number: `SR-${new Date().getFullYear()}-${String(appData.requests.length + 1).padStart(3, '0')}`,
                clientId: clientId,
                clientName: client.name,
                address: document.getElementById('requestAddress').value,
                problem: document.getElementById('problemType').value,
                priority: document.getElementById('requestPriority').value,
                status: 'NEW',
                masterId: null,
                createdAt: new Date().toISOString()
            });
            saveData(); closeModal(); renderPage('requests');
        }

        function assignMaster(id) {
            const mastersOptions = appData.masters.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
            openModal('Назначить мастера', `
                <form onsubmit="saveAssignment(event, ${id})">
                    <div class="form-group"><label>Мастер</label><select id="masterSelect" required>${mastersOptions}</select></div>
                    <div class="form-actions"><button type="button" class="btn" onclick="closeModal()">Отмена</button><button type="submit" class="btn btn-primary">Назначить</button></div>
                </form>
            `);
        }

        function saveAssignment(e, id) {
            e.preventDefault();
            const r = appData.requests.find(r => r.id === id);
            r.masterId = parseInt(document.getElementById('masterSelect').value);
            r.status = 'IN_PROGRESS';
            saveData(); closeModal(); renderPage('requests');
        }

        function completeRequest(id) {
            if (confirm('Подтвердите выполнение')) {
                const r = appData.requests.find(r => r.id === id);
                r.status = 'DONE';
                saveData(); renderPage('requests');
            }
        }

        function deleteRequest(id) {
            if (confirm('Удалить заявку?')) {
                appData.requests = appData.requests.filter(r => r.id !== id);
                saveData(); renderPage('requests');
            }
        }

        // ========== МАСТЕРА (только для менеджера) ==========
        function renderMasters(container) {
            if (currentUser.role === 'MASTER') {
                container.innerHTML = '<div class="table-container"><h2>Доступ запрещен</h2><p>У вас нет прав для просмотра этого раздела.</p></div>';
                return;
            }
            
            container.innerHTML = `
                <div class="table-container">
                    <div class="table-header"><h2>Мастера</h2><button class="btn btn-primary" onclick="showAddMasterModal()"><i class="fas fa-plus"></i> Добавить</button></div>
                    <div class="search-box"><i class="fas fa-search"></i><input type="text" id="masterSearch" placeholder="Поиск..." onkeyup="searchTable('masterSearch', 'mastersTable')"></div>
                    <table id="mastersTable"><thead><tr><th>ID</th><th>ФИО</th><th>Телефон</th><th>Специализация</th><th>Статус</th><th>Действия</th></tr></thead><tbody>
                        ${appData.masters.map(m => `<tr>
                            <td>${m.id}</td><td>${m.name}</td><td>${m.phone}</td><td>${m.specialization}</td>
                            <td><span class="status-badge status-${m.status === 'ACTIVE' ? 'done' : 'cancelled'}">${m.status}</span></td>
                            <td class="action-icons"><i class="fas fa-edit" onclick="showEditMasterModal(${m.id})"></i> <i class="fas fa-trash" onclick="deleteMaster(${m.id})"></i></td>
                        </tr>`).join('')}
                    </tbody></table>
                </div>
            `;
        }

        function showAddMasterModal() {
            openModal('Добавить мастера', `
                <form onsubmit="saveMaster(event)">
                    <div class="form-group"><label>ФИО *</label><input type="text" id="masterName" required></div>
                    <div class="form-group"><label>Телефон *</label><input type="tel" id="masterPhone" required></div>
                    <div class="form-group"><label>Специализация</label><input type="text" id="masterSpecialization" value="Ремонт"></div>
                    <div class="form-actions"><button type="button" class="btn" onclick="closeModal()">Отмена</button><button type="submit" class="btn btn-primary">Сохранить</button></div>
                </form>
            `);
        }

        function saveMaster(e) {
            e.preventDefault();
            appData.masters.push({
                id: Date.now(),
                name: document.getElementById('masterName').value,
                phone: document.getElementById('masterPhone').value,
                specialization: document.getElementById('masterSpecialization').value,
                status: 'ACTIVE'
            });
            saveData(); closeModal(); renderPage('masters');
        }

        function deleteMaster(id) {
            if (confirm('Удалить мастера?')) {
                appData.masters = appData.masters.filter(m => m.id !== id);
                saveData(); renderPage('masters');
            }
        }

        // ========== СКЛАД ==========
        function renderWarehouse(container) {
            container.innerHTML = `
                <div class="table-container">
                    <div class="table-header"><h2>Склад</h2>
                        ${currentUser.role !== 'MASTER' ? '<button class="btn btn-primary" onclick="showAddItemModal()"><i class="fas fa-plus"></i> Добавить</button>' : ''}
                    </div>
                    <div class="search-box"><i class="fas fa-search"></i><input type="text" id="warehouseSearch" placeholder="Поиск..." onkeyup="searchTable('warehouseSearch', 'warehouseTable')"></div>
                    <table id="warehouseTable"><thead><tr><th>Название</th><th>Артикул</th><th>Кол-во</th><th>Цена</th><th>Статус</th><th>Действия</th></tr></thead><tbody>
                        ${appData.warehouse.map(i => `<tr>
                            <td>${i.name}</td><td>${i.sku}</td><td>${i.quantity}</td><td>${i.price} ₽</td>
                            <td><span class="status-badge ${i.quantity <= i.minQuantity ? 'status-cancelled' : 'status-done'}">${i.quantity <= i.minQuantity ? 'Мало' : 'Есть'}</span></td>
                            <td class="action-icons">
                                ${currentUser.role === 'MASTER' ? 
                                    '<i class="fas fa-minus-circle" onclick="useMaterial(' + i.id + ')"></i>' : 
                                    '<i class="fas fa-plus-circle" onclick="addStock(' + i.id + ')"></i> <i class="fas fa-edit" onclick="showEditItemModal(' + i.id + ')"></i> <i class="fas fa-trash" onclick="deleteItem(' + i.id + ')"></i>'}
                            </td>
                        </tr>`).join('')}
                    </tbody></table>
                </div>
            `;
        }

        function showAddItemModal() {
            openModal('Добавить материал', `
                <form onsubmit="saveItem(event)">
                    <div class="form-group"><label>Название *</label><input type="text" id="itemName" required></div>
                    <div class="form-group"><label>Артикул *</label><input type="text" id="itemSku" required></div>
                    <div class="form-group"><label>Количество</label><input type="number" id="itemQuantity" value="0" min="0"></div>
                    <div class="form-group"><label>Цена</label><input type="number" id="itemPrice" value="0" min="0"></div>
                    <div class="form-actions"><button type="button" class="btn" onclick="closeModal()">Отмена</button><button type="submit" class="btn btn-primary">Сохранить</button></div>
                </form>
            `);
        }

        function saveItem(e) {
            e.preventDefault();
            appData.warehouse.push({
                id: Date.now(),
                name: document.getElementById('itemName').value,
                sku: document.getElementById('itemSku').value,
                quantity: parseInt(document.getElementById('itemQuantity').value) || 0,
                minQuantity: 2,
                price: parseFloat(document.getElementById('itemPrice').value) || 0
            });
            saveData(); closeModal(); renderPage('warehouse');
        }

        function showEditItemModal(id) {
            const item = appData.warehouse.find(i => i.id === id);
            openModal('Редактировать', `
                <form onsubmit="updateItem(event, ${id})">
                    <div class="form-group"><label>Название</label><input type="text" id="itemName" value="${item.name}"></div>
                    <div class="form-group"><label>Артикул</label><input type="text" id="itemSku" value="${item.sku}"></div>
                    <div class="form-group"><label>Цена</label><input type="number" id="itemPrice" value="${item.price}"></div>
                    <div class="form-actions"><button type="button" class="btn" onclick="closeModal()">Отмена</button><button type="submit" class="btn btn-primary">Обновить</button></div>
                </form>
            `);
        }

        function updateItem(e, id) {
            e.preventDefault();
            const item = appData.warehouse.find(i => i.id === id);
            item.name = document.getElementById('itemName').value;
            item.sku = document.getElementById('itemSku').value;
            item.price = parseFloat(document.getElementById('itemPrice').value) || 0;
            saveData(); closeModal(); renderPage('warehouse');
        }

        function addStock(id) {
            const item = appData.warehouse.find(i => i.id === id);
            if (item) {
                item.quantity++;
                saveData(); renderPage('warehouse');
            }
        }

        function useMaterial(id) {
            const item = appData.warehouse.find(i => i.id === id);
            if (item && item.quantity > 0) {
                if (confirm('Списать 1 единицу?')) {
                    item.quantity--;
                    saveData(); renderPage('warehouse');
                }
            } else {
                alert('Нет в наличии');
            }
        }

        function deleteItem(id) {
            if (confirm('Удалить?')) {
                appData.warehouse = appData.warehouse.filter(i => i.id !== id);
                saveData(); renderPage('warehouse');
            }
        }

        // ========== ПОИСК ==========
        function searchTable(inputId, tableId) {
            const search = document.getElementById(inputId).value.toLowerCase();
            const rows = document.getElementById(tableId).getElementsByTagName('tbody')[0].getElementsByTagName('tr');
            Array.from(rows).forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        }

        // Экспорт функций для HTML
        window.loginAsManager = loginAsManager;
        window.loginAsMaster = loginAsMaster;
        window.showAddClientModal = showAddClientModal;
        window.showEditClientModal = showEditClientModal;
        window.saveClient = saveClient;
        window.updateClient = updateClient;
        window.deleteClient = deleteClient;
        window.showAddRequestModal = showAddRequestModal;
        window.saveRequest = saveRequest;
        window.assignMaster = assignMaster;
        window.saveAssignment = saveAssignment;
        window.completeRequest = completeRequest;
        window.deleteRequest = deleteRequest;
        window.showAddMasterModal = showAddMasterModal;
        window.saveMaster = saveMaster;
        window.deleteMaster = deleteMaster;
        window.showAddItemModal = showAddItemModal;
        window.saveItem = saveItem;
        window.showEditItemModal = showEditItemModal;
        window.updateItem = updateItem;
        window.addStock = addStock;
        window.useMaterial = useMaterial;
        window.deleteItem = deleteItem;
        window.searchTable = searchTable;
        window.closeModal = closeModal;
        window.renderPage = renderPage;
    </script>
</body>
</html>